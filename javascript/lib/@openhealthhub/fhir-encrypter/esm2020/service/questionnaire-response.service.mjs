import _ from 'lodash';
import { getAnswerType, getValueForType } from '../models/supported-answer-type';
import { STRUCTURE_DEFINITION_URL } from '../util/fhir-constants';
export class QuestionnaireResponseService {
    constructor(encryptService, key) {
        this.encryptService = encryptService;
        this.key = key;
    }
    async createEncryptedResponse(originalResponse) {
        const response = _.cloneDeep(originalResponse);
        response.meta = response.meta ?? {};
        response.meta.profile = [`${STRUCTURE_DEFINITION_URL}EncryptedQuestionnaireResponse`];
        this.setPractitioner(response, this.key.practitioner);
        await this.encryptAnswers(response);
        return response;
    }
    async encryptAnswers(response) {
        const itemMap = {};
        await this.encryptItem(itemMap, response.item);
        await this.encryptAllAnswers(itemMap, response);
    }
    async encryptItem(itemMap, items = []) {
        await Promise.all(items.map(async (item) => {
            const answers = item.answer;
            if (answers && answers.length > 0) {
                await Promise.all(answers.map(async (answer) => {
                    await this.encryptAnswer(answer, item, itemMap);
                }));
            }
            await this.encryptItem(itemMap, item.item);
        }));
    }
    async encryptAnswer(answer, item, itemMap) {
        const answerType = getAnswerType(answer);
        const value = getValueForType(answer, answerType);
        const extensions = answer.extension ?? [];
        const codes = extensions.filter(ext => ext.url === `${STRUCTURE_DEFINITION_URL}question-answer-option-coding`)
            .filter(ext => !!ext.valueCoding)
            .map(ext => ext.valueCoding) ?? [];
        if (value) {
            const answerArray = item.linkId in itemMap ? itemMap[item.linkId] : [];
            const valueIsCode = typeof value !== 'string' && typeof value !== 'number';
            const actValue = valueIsCode ? undefined : value;
            const actualCodes = (valueIsCode ? [...codes, value] : codes);
            const encryptedObj = { value: actValue, codes: actualCodes };
            answerArray.push(encryptedObj);
            itemMap[item.linkId] = answerArray;
            await this.setEncryptedValue(answer, encryptedObj, answerType);
        }
    }
    async setEncryptedValue(answer, value, answerType) {
        const valueString = await this.encryptValue(value);
        switch (answerType) {
            case 'ATTACHMENT':
                answer.valueAttachment = this.createValueWithEncryptExtension(valueString, 'encrypted-attachment');
                return;
            case 'DATE':
                // eslint-disable-next-line no-underscore-dangle
                answer._valueDate = this.createValueWithEncryptExtension(valueString, 'encrypted-dateType');
                delete answer.valueDate;
                return;
            case 'DECIMAL':
                // @ts-expect-error: _valueDecimal should be present in FHIR types
                // eslint-disable-next-line no-underscore-dangle
                answer._valueDecimal = this.createValueWithEncryptExtension(valueString, 'encrypted-decimalType');
                delete answer.valueDecimal;
                return;
            case 'STRING':
                // eslint-disable-next-line no-underscore-dangle
                answer._valueString = this.createValueWithEncryptExtension(valueString, 'encrypted-stringType');
                delete answer.valueString;
                return;
            case 'CODING':
                answer.valueCoding = this.createValueWithEncryptExtension(valueString, 'encrypted-coding');
                return;
            default:
                throw new Error('unknown answerType');
        }
    }
    createValueWithEncryptExtension(valueString, extensionType) {
        return { extension: [{ url: STRUCTURE_DEFINITION_URL + extensionType, valueString }] };
    }
    async encryptAllAnswers(itemMap, response) {
        const allEncrypted = await this.encryptValue(itemMap);
        response.extension = [{ url: `${STRUCTURE_DEFINITION_URL}encryptedAnswers`, valueString: allEncrypted }];
    }
    async encryptValue(value) {
        return this.encryptService.encrypt(JSON.stringify(value), this.key);
    }
    setPractitioner(response, practitioner) {
        const contained = response.contained ?? [];
        contained.push(practitioner);
        response.contained = contained;
        response.author = { reference: `#${practitioner.id}` };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlc3Rpb25uYWlyZS1yZXNwb25zZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi9zZXJ2aWNlL3F1ZXN0aW9ubmFpcmUtcmVzcG9uc2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFTQSxPQUFPLENBQUMsTUFBTSxRQUFRLENBQUM7QUFHdkIsT0FBTyxFQUFDLGFBQWEsRUFBRSxlQUFlLEVBQXNCLE1BQU0saUNBQWlDLENBQUM7QUFDcEcsT0FBTyxFQUFDLHdCQUF3QixFQUFDLE1BQU0sd0JBQXdCLENBQUM7QUFHaEUsTUFBTSxPQUFPLDRCQUE0QjtJQUN2QyxZQUE2QixjQUE4QixFQUFtQixHQUFvQjtRQUFyRSxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFBbUIsUUFBRyxHQUFILEdBQUcsQ0FBaUI7SUFBRyxDQUFDO0lBRXRHLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxnQkFBdUM7UUFDbkUsTUFBTSxRQUFRLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBRS9DLFFBQVEsQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUM7UUFDcEMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxHQUFHLHdCQUF3QixnQ0FBZ0MsQ0FBQyxDQUFDO1FBRXRGLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFdEQsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRXBDLE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFTyxLQUFLLENBQUMsY0FBYyxDQUFDLFFBQStCO1FBQzFELE1BQU0sT0FBTyxHQUE4QyxFQUFFLENBQUM7UUFFOUQsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsSUFB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O1FBQ2pILE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN0RCxRQUFRLENBQUMsU0FBUyxHQUFHLENBQUMsRUFBQyxHQUFHLEVBQUUsR0FBRyx3QkFBd0Isa0JBQWtCLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBQyxDQUFDLENBQUM7SUFDekcsQ0FBQztJQUVPLEtBQUssQ0FBQyxZQUFZLENBQUMsS0FBYTtRQUN0QyxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3RFLENBQUM7SUFFTyxlQUFlLENBQUMsUUFBK0IsRUFBRSxZQUEwQjtRQUNqRixNQUFNLFNBQVMsR0FBRyxRQUFRLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBQztRQUMzQyxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzdCLFFBQVEsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQy9CLFFBQVEsQ0FBQyxNQUFNLEdBQUcsRUFBQyxTQUFTLEVBQUUsSUFBSSxZQUFZLENBQUMsRUFBWSxFQUFFLEVBQUMsQ0FBQztJQUNqRSxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBCYWNrYm9uZUVsZW1lbnQsXG4gIENvZGluZyxcbiAgRXh0ZW5zaW9uLFxuICBQcmFjdGl0aW9uZXIsXG4gIFF1ZXN0aW9ubmFpcmVSZXNwb25zZSxcbiAgUXVlc3Rpb25uYWlyZVJlc3BvbnNlSXRlbSxcbiAgUXVlc3Rpb25uYWlyZVJlc3BvbnNlSXRlbUFuc3dlclxufSBmcm9tICdmaGlyL3I0JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQge0VuY3J5cHRlZFF1ZXN0aW9uQW5zd2VyfSBmcm9tICcuLi9tb2RlbHMvZW5jcnlwdGVkLXF1ZXN0aW9uLWFuc3dlcic7XG5pbXBvcnQge1ByYWN0aXRpb25lcktleX0gZnJvbSAnLi4vbW9kZWxzL3ByYWN0aXRpb25lci1rZXknO1xuaW1wb3J0IHtnZXRBbnN3ZXJUeXBlLCBnZXRWYWx1ZUZvclR5cGUsIFN1cHBvcnRlZEFuc3dlclR5cGV9IGZyb20gJy4uL21vZGVscy9zdXBwb3J0ZWQtYW5zd2VyLXR5cGUnO1xuaW1wb3J0IHtTVFJVQ1RVUkVfREVGSU5JVElPTl9VUkx9IGZyb20gJy4uL3V0aWwvZmhpci1jb25zdGFudHMnO1xuaW1wb3J0IHtFbmNyeXB0U2VydmljZX0gZnJvbSAnLi9lbmNyeXB0LnNlcnZpY2UnO1xuXG5leHBvcnQgY2xhc3MgUXVlc3Rpb25uYWlyZVJlc3BvbnNlU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgZW5jcnlwdFNlcnZpY2U6IEVuY3J5cHRTZXJ2aWNlLCBwcml2YXRlIHJlYWRvbmx5IGtleTogUHJhY3RpdGlvbmVyS2V5KSB7fVxuXG4gIGFzeW5jIGNyZWF0ZUVuY3J5cHRlZFJlc3BvbnNlKG9yaWdpbmFsUmVzcG9uc2U6IFF1ZXN0aW9ubmFpcmVSZXNwb25zZSk6IFByb21pc2U8UXVlc3Rpb25uYWlyZVJlc3BvbnNlPiB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBfLmNsb25lRGVlcChvcmlnaW5hbFJlc3BvbnNlKTtcblxuICAgIHJlc3BvbnNlLm1ldGEgPSByZXNwb25zZS5tZXRhID8/IHt9O1xuICAgIHJlc3BvbnNlLm1ldGEucHJvZmlsZSA9IFtgJHtTVFJVQ1RVUkVfREVGSU5JVElPTl9VUkx9RW5jcnlwdGVkUXVlc3Rpb25uYWlyZVJlc3BvbnNlYF07XG5cbiAgICB0aGlzLnNldFByYWN0aXRpb25lcihyZXNwb25zZSwgdGhpcy5rZXkucHJhY3RpdGlvbmVyKTtcblxuICAgIGF3YWl0IHRoaXMuZW5jcnlwdEFuc3dlcnMocmVzcG9uc2UpO1xuXG4gICAgcmV0dXJuIHJlc3BvbnNlO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBlbmNyeXB0QW5zd2VycyhyZXNwb25zZTogUXVlc3Rpb25uYWlyZVJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgaXRlbU1hcDogUmVjb3JkPHN0cmluZywgRW5jcnlwdGVkUXVlc3Rpb25BbnN3ZXJbXT4gPSB7fTtcblxuICAgIGF3YWl0IHRoaXMuZW5jcnlwdEl0ZW0oaXRlbU1hcCwgcmVzcG9uc2UuaXRlbSk7XG5cbiAgICBhd2FpdCB0aGlzLmVuY3J5cHRBbGxBbnN3ZXJzKGl0ZW1NYXAsIHJlc3BvbnNlKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZW5jcnlwdEl0ZW0oaXRlbU1hcDogUmVjb3JkPHN0cmluZywgRW5jcnlwdGVkUXVlc3Rpb25BbnN3ZXJbXT4sIGl0ZW1zOiBRdWVzdGlvbm5haXJlUmVzcG9uc2VJdGVtW10gPSBbXSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IFByb21pc2UuYWxsKGl0ZW1zLm1hcChhc3luYyBpdGVtID0+IHtcbiAgICAgIGNvbnN0IGFuc3dlcnMgPSBpdGVtLmFuc3dlcjtcbiAgICAgIGlmIChhbnN3ZXJzICYmIGFuc3dlcnMubGVuZ3RoID4gMCkge1xuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChhbnN3ZXJzLm1hcChhc3luYyBhbnN3ZXIgPT4ge1xuICAgICAgICAgIGF3YWl0IHRoaXMuZW5jcnlwdEFuc3dlcihhbnN3ZXIsIGl0ZW0sIGl0ZW1NYXApO1xuICAgICAgICB9KSk7XG4gICAgICB9XG5cbiAgICAgIGF3YWl0IHRoaXMuZW5jcnlwdEl0ZW0oaXRlbU1hcCwgaXRlbS5pdGVtKTtcbiAgICB9KSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGVuY3J5cHRBbnN3ZXIoYW5zd2VyOiBRdWVzdGlvbm5haXJlUmVzcG9uc2VJdGVtQW5zd2VyLCBpdGVtOiBRdWVzdGlvbm5haXJlUmVzcG9uc2VJdGVtLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbU1hcDogUmVjb3JkPHN0cmluZywgRW5jcnlwdGVkUXVlc3Rpb25BbnN3ZXJbXT4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBhbnN3ZXJUeXBlID0gZ2V0QW5zd2VyVHlwZShhbnN3ZXIpO1xuICAgIGNvbnN0IHZhbHVlID0gZ2V0VmFsdWVGb3JUeXBlKGFuc3dlciwgYW5zd2VyVHlwZSk7XG4gICAgY29uc3QgZXh0ZW5zaW9uczogRXh0ZW5zaW9uW10gPSBhbnN3ZXIuZXh0ZW5zaW9uID8/IFtdO1xuICAgIGNvbnN0IGNvZGVzID0gZXh0ZW5zaW9ucy5maWx0ZXIoZXh0ID0+IGV4dC51cmwgPT09IGAke1NUUlVDVFVSRV9ERUZJTklUSU9OX1VSTH1xdWVzdGlvbi1hbnN3ZXItb3B0aW9uLWNvZGluZ2ApXG4gICAgICAuZmlsdGVyKGV4dCA9PiAhIWV4dC52YWx1ZUNvZGluZylcbiAgICAgIC5tYXAoZXh0ID0+IGV4dC52YWx1ZUNvZGluZykgPz8gW107XG5cbiAgICBpZiAodmFsdWUpIHtcbiAgICAgIGNvbnN0IGFuc3dlckFycmF5ID0gaXRlbS5saW5rSWQgaW4gaXRlbU1hcCA/IGl0ZW1NYXBbaXRlbS5saW5rSWRdIDogW107XG4gICAgICBjb25zdCB2YWx1ZUlzQ29kZSA9IHR5cGVvZiB2YWx1ZSAhPT0gJ3N0cmluZycgJiYgdHlwZW9mIHZhbHVlICE9PSAnbnVtYmVyJztcbiAgICAgIGNvbnN0IGFjdFZhbHVlID0gdmFsdWVJc0NvZGUgPyB1bmRlZmluZWQgOiB2YWx1ZTtcbiAgICAgIGNvbnN0IGFjdHVhbENvZGVzID0gKHZhbHVlSXNDb2RlID8gWy4uLmNvZGVzLCB2YWx1ZV0gOiBjb2RlcykgYXMgQ29kaW5nW107XG4gICAgICBjb25zdCBlbmNyeXB0ZWRPYmogPSB7dmFsdWU6IGFjdFZhbHVlLCBjb2RlczogYWN0dWFsQ29kZXN9O1xuICAgICAgYW5zd2VyQXJyYXkucHVzaChlbmNyeXB0ZWRPYmopO1xuICAgICAgaXRlbU1hcFtpdGVtLmxpbmtJZF0gPSBhbnN3ZXJBcnJheTtcblxuICAgICAgYXdhaXQgdGhpcy5zZXRFbmNyeXB0ZWRWYWx1ZShhbnN3ZXIsIGVuY3J5cHRlZE9iaiwgYW5zd2VyVHlwZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzZXRFbmNyeXB0ZWRWYWx1ZShhbnN3ZXI6IFF1ZXN0aW9ubmFpcmVSZXNwb25zZUl0ZW1BbnN3ZXIsIHZhbHVlOiBFbmNyeXB0ZWRRdWVzdGlvbkFuc3dlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbnN3ZXJUeXBlOiBrZXlvZiB0eXBlb2YgU3VwcG9ydGVkQW5zd2VyVHlwZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHZhbHVlU3RyaW5nID0gYXdhaXQgdGhpcy5lbmNyeXB0VmFsdWUodmFsdWUpO1xuICAgIHN3aXRjaCAoYW5zd2VyVHlwZSkge1xuICAgICAgY2FzZSAnQVRUQUNITUVOVCc6XG4gICAgICAgIGFuc3dlci52YWx1ZUF0dGFjaG1lbnQgPSB0aGlzLmNyZWF0ZVZhbHVlV2l0aEVuY3J5cHRFeHRlbnNpb24odmFsdWVTdHJpbmcsICdlbmNyeXB0ZWQtYXR0YWNobWVudCcpO1xuXG4gICAgICAgIHJldHVybjtcbiAgICAgIGNhc2UgJ0RBVEUnOlxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW5kZXJzY29yZS1kYW5nbGVcbiAgICAgICAgYW5zd2VyLl92YWx1ZURhdGUgPSB0aGlzLmNyZWF0ZVZhbHVlV2l0aEVuY3J5cHRFeHRlbnNpb24odmFsdWVTdHJpbmcsICdlbmNyeXB0ZWQtZGF0ZVR5cGUnKTtcbiAgICAgICAgZGVsZXRlIGFuc3dlci52YWx1ZURhdGU7XG5cbiAgICAgICAgcmV0dXJuO1xuICAgICAgY2FzZSAnREVDSU1BTCc6XG4gICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3I6IF92YWx1ZURlY2ltYWwgc2hvdWxkIGJlIHByZXNlbnQgaW4gRkhJUiB0eXBlc1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW5kZXJzY29yZS1kYW5nbGVcbiAgICAgICAgYW5zd2VyLl92YWx1ZURlY2ltYWwgPSB0aGlzLmNyZWF0ZVZhbHVlV2l0aEVuY3J5cHRFeHRlbnNpb24odmFsdWVTdHJpbmcsICdlbmNyeXB0ZWQtZGVjaW1hbFR5cGUnKTtcbiAgICAgICAgZGVsZXRlIGFuc3dlci52YWx1ZURlY2ltYWw7XG5cbiAgICAgICAgcmV0dXJuO1xuICAgICAgY2FzZSAnU1RSSU5HJzpcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG4gICAgICAgIGFuc3dlci5fdmFsdWVTdHJpbmcgPSB0aGlzLmNyZWF0ZVZhbHVlV2l0aEVuY3J5cHRFeHRlbnNpb24odmFsdWVTdHJpbmcsICdlbmNyeXB0ZWQtc3RyaW5nVHlwZScpO1xuICAgICAgICBkZWxldGUgYW5zd2VyLnZhbHVlU3RyaW5nO1xuXG4gICAgICAgIHJldHVybjtcbiAgICAgIGNhc2UgJ0NPRElORyc6XG4gICAgICAgIGFuc3dlci52YWx1ZUNvZGluZyA9IHRoaXMuY3JlYXRlVmFsdWVXaXRoRW5jcnlwdEV4dGVuc2lvbih2YWx1ZVN0cmluZywgJ2VuY3J5cHRlZC1jb2RpbmcnKTtcblxuICAgICAgICByZXR1cm47XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Vua25vd24gYW5zd2VyVHlwZScpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlVmFsdWVXaXRoRW5jcnlwdEV4dGVuc2lvbih2YWx1ZVN0cmluZzogc3RyaW5nLCBleHRlbnNpb25UeXBlOiBzdHJpbmcpOiBCYWNrYm9uZUVsZW1lbnQge1xuICAgIHJldHVybiB7ZXh0ZW5zaW9uOiBbe3VybDogU1RSVUNUVVJFX0RFRklOSVRJT05fVVJMICsgZXh0ZW5zaW9uVHlwZSwgdmFsdWVTdHJpbmd9XX07XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGVuY3J5cHRBbGxBbnN3ZXJzKGl0ZW1NYXA6IFJlY29yZDxzdHJpbmcsIEVuY3J5cHRlZFF1ZXN0aW9uQW5zd2VyW10+LCByZXNwb25zZTogUXVlc3Rpb25uYWlyZVJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgYWxsRW5jcnlwdGVkID0gYXdhaXQgdGhpcy5lbmNyeXB0VmFsdWUoaXRlbU1hcCk7XG4gICAgcmVzcG9uc2UuZXh0ZW5zaW9uID0gW3t1cmw6IGAke1NUUlVDVFVSRV9ERUZJTklUSU9OX1VSTH1lbmNyeXB0ZWRBbnN3ZXJzYCwgdmFsdWVTdHJpbmc6IGFsbEVuY3J5cHRlZH1dO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBlbmNyeXB0VmFsdWUodmFsdWU6IG9iamVjdCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMuZW5jcnlwdFNlcnZpY2UuZW5jcnlwdChKU09OLnN0cmluZ2lmeSh2YWx1ZSksIHRoaXMua2V5KTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0UHJhY3RpdGlvbmVyKHJlc3BvbnNlOiBRdWVzdGlvbm5haXJlUmVzcG9uc2UsIHByYWN0aXRpb25lcjogUHJhY3RpdGlvbmVyKTogdm9pZCB7XG4gICAgY29uc3QgY29udGFpbmVkID0gcmVzcG9uc2UuY29udGFpbmVkID8/IFtdO1xuICAgIGNvbnRhaW5lZC5wdXNoKHByYWN0aXRpb25lcik7XG4gICAgcmVzcG9uc2UuY29udGFpbmVkID0gY29udGFpbmVkO1xuICAgIHJlc3BvbnNlLmF1dGhvciA9IHtyZWZlcmVuY2U6IGAjJHtwcmFjdGl0aW9uZXIuaWQgYXMgc3RyaW5nfWB9O1xuICB9XG59XG4iXX0=